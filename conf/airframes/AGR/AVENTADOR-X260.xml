<!DOCTYPE airframe SYSTEM "../airframe.dtd">

<!--
    AVENTADOR X260 - FLYWING
    YAPA v2 board
    MPU6000 - HMC5883 - MS5611 IMU
    AiRSPEED_ETS
    Teemetry RFD900 transparent mode
-->

<airframe name="AVENTADOR X260 FLYWING - YAPA v2">
	<firmware name="fixedwing">
		<target name="ap" board="twog_1.0"/>
		<target name="sim" board="pc"/>
    		<define name="AGR_CLIMB"/>
		<!--    <define name="LOITER_TRIM"/>  -->
		<!--    <define name="WIND_INFO"/>    -->
		<!--    <define name="WIND_INFO_RET"/>-->
		<!--    <define name="STRONG_WIND"/>  -->
                <define name="USE_CAM_DOOR"/>
		<define name="RADIO_SHOOT"  value="RADIO_CH7"/>
		<define name="USE_I2C0"/>
		<define name="USE_ADC"/>
		<define name="USE_ADC_0"/>  <!-- motor_temp_sensor-->
		<define name="USE_ADC_1"/>  <!-- esc_temp_sensor-->
		<define name="USE_ADC_6"/>  <!-- current_sensor-->
                <define name="USE_AIRSPEED_ETS"/>
	        <!--<define name="USE_AIRSPEED_MS45XX"/> -->		
                <define name="AIRSPEED_ETS_SYNC_SEND"/>
		<define name="SENSOR_SYNC_SEND"/>
		<configure name="AHRS_ALIGNER_LED" value="3"/>
		<configure name="GPS_LED" value="2"/>
		<configure name="SYS_TIME_LED" value="1"/>
		<subsystem name="radio_control" type="ppm"/>
                <define name="RADIO_KILL_SWITCH" value="RADIO_CH6"/>
		<subsystem name="telemetry" type="transparent"/>
		<subsystem name="control" type="new"/>
		<subsystem name="ahrs" type="int_cmpl_quat">   <!--float_dcm   int_cmpl_quat-->
			<configure name="USE_MAGNETOMETER" value="0"/>
			<define name="AHRS_USE_GPS_HEADING"/>
			<define name="AHRS_GRAVITY_UPDATE_COORDINATED_TURN"/>
			<define name="AHRS_GRAVITY_UPDATE_NORM_HEURISTIC"/>
		</subsystem>
		<subsystem name="imu" type="drotek_10dof_v2"/>
                    <define name="DROTEK_2_MPU_I2C_ADDR"  value="MPU60X0_ADDR"/>
              <!--      <define name="DROTEK_2_LOWPASS_FILTER"  value="MPU60X0_DLPF_05HZ"/>
                    <define name="DROTEK_2_SMPLRT_DIV"  value="9"/>
                    <define name="IMU_ACCEL_MA_FILTER_WINDOW" value="12"/> -->
                    <define name="IMU_DROTEK_2_ORIENTATION_IC_UP"/>
                    <define name="MS5611_SLAVE_ADDR"  value="0xEE"/>
		<subsystem name="gps" type="ublox"/>  <!--mediatek_diy-->
		    <configure name="GPS_BAUD" value="B38400"/>
                    <configure name="GPS_PORT"  value="UART0"/>
                   <!-- <define name="GPS_TIMESTAMP"/> -->
		<subsystem name="navigation"/>
                <subsystem name="ins" type="alt_float"/>
		    <define name="USE_BAROMETER"/>
		    <define name="USE_BARO_MS5611"/>
                    <define name="INS_BARO_ID"  value="BARO_MS5611_SENDER_ID"/>
	</firmware>

<!-- commands section -->
	<servos>
    		<servo name="THROTTLE"      no="9" min="1000" neutral="1000" max="2000"/>
		<servo name="AILEVON_LEFT"  no="7" min="2000" neutral="1500" max="1000"/>
		<servo name="AILEVON_RIGHT" no="6" min="1000" neutral="1500" max="2000"/>
		<servo name="CAM_ROLL"      no="2" min="1550" neutral="1385" max="1190"/>
		<servo name="CAM_DOOR"      no="5" min="1800" neutral="1500" max="1000"/>
	</servos>

	<commands>
		<axis name="THROTTLE"  failsafe_value="0"/>
		<axis name="ROLL"      failsafe_value="0"/>
		<axis name="PITCH"     failsafe_value="0"/>
		<axis name="CAM_ROLL"  failsafe_value="0"/>
		<axis name="CAM_DOOR"  failsafe_value="0"/>
	</commands>

	<rc_commands>
		<set command="THROTTLE"  value="@THROTTLE"/>
		<set command="ROLL"      value="@ROLL"/>
		<set command="PITCH"     value="@PITCH"/>
		<set command="CAM_DOOR"  value="@CH8"/>		
	</rc_commands>
 
	<auto_rc_commands>
		<!--<set command="CAM_COVER" value="@CH8"/> -->
	</auto_rc_commands>
	
	<ap_only_commands>
	  <copy command="CAM_ROLL"/>
	</ap_only_commands>

	<section name="MIXER">
		<define name="AILEVON_AILERON_RATE"  value="0.75"/>
		<define name="AILEVON_ELEVATOR_RATE" value="0.75"/>
		<define name="BRAKE_DEFLECTION_TIME" value="2.0" /> <!-- seconds -->
		<define name="MAX_BRAKE_RATE" value="(MAX_PPRZ / (60 * BRAKE_DEFLECTION_TIME ))" />
	</section>

  <command_laws>
    <set servo="THROTTLE" value="@THROTTLE"/>
    <let var="aileron" value="@ROLL * AILEVON_AILERON_RATE"/>
    <let var="elevator" value="@PITCH * AILEVON_ELEVATOR_RATE"/>
    <set servo="AILEVON_RIGHT" value="-$aileron + $elevator"/>
    <set servo="AILEVON_LEFT"  value="$aileron + $elevator"/>
    <set servo="CAM_ROLL" value="@CAM_ROLL"/>
    <ratelimit var="brake_value" value="Chop(@CAM_DOOR, -MAX_PPRZ, MAX_PPRZ)" rate_min="-MAX_BRAKE_RATE" rate_max="MAX_BRAKE_RATE" />
    <set servo="CAM_DOOR" value="$brake_value"/>
  </command_laws>

  <section name="AUTO1" prefix="AUTO1_">
    <define name="MAX_ROLL" value="60" unit="deg"/>  <!-- 50 -->
    <define name="MAX_PITCH" value="45" unit="deg"/> <!-- 35-->
  </section>

 <section name="IMU" prefix="IMU_">

    <define name="GYRO_P_NEUTRAL" value="0"/>
    <define name="GYRO_Q_NEUTRAL" value="0"/>
    <define name="GYRO_R_NEUTRAL" value="0"/>

    <define name="ACCEL_X_NEUTRAL" value="192"/> <!--tilt -->
    <define name="ACCEL_Y_NEUTRAL" value="36"/> <!--roll -->
    <define name="ACCEL_Z_NEUTRAL" value="0"/>
    
    <define name="MAG_X_NEUTRAL"   value="0"/>
    <define name="MAG_Y_NEUTRAL"   value="0"/>
    <define name="MAG_Z_NEUTRAL"   value="0"/>
    <define name="MAG_X_SENS"      value="1." integer="16"/>
    <define name="MAG_Y_SENS"      value="1." integer="16"/>
    <define name="MAG_Z_SENS"      value="1." integer="16"/>

    <define name="BODY_TO_IMU_PHI"   value="RadOfDeg(0.)"/>
    <define name="BODY_TO_IMU_THETA" value="RadOfDeg(0.)"/>
    <define name="BODY_TO_IMU_PSI"   value="RadOfDeg(0.)"/>
  </section>

  <section name="INS" prefix="INS_">
    <define name="ROLL_NEUTRAL_DEFAULT"  value="0" unit="deg"/>
    <define name="PITCH_NEUTRAL_DEFAULT" value="3" unit="deg"/>
  </section>

  <section name="BAT">
    <define name="ADC_CHANNEL_CURRENT"   value="ADC_6"/>
    <define name="MilliAmpereOfAdc(adc)" value="(128*(adc-122))"/> <!-- sensor 100amp  -->
    <define name="CATASTROPHIC_BAT_LEVEL" value="12.4" unit="V"/>
    <define name="CRITIC_BAT_LEVEL"       value="13.0" unit="V"/>
    <define name="LOW_BAT_LEVEL"          value="13.8" unit="V"/>
    <define name="MAX_BAT_LEVEL"          value="16.8" unit="V"/>
  </section>

  <section name="MISC">
    <define name="SENSOR_SYNC_SEND"/>
    <define name="MINIMUM_AIRSPEED"      value="16." unit="m/s"/> <!-- nao tinha -->
    <define name="NOMINAL_AIRSPEED"      value="24." unit="m/s"/> <!--28.muito bom - nao cai nas curvas a 50ยบ --> 
    <define name="MAXIMUM_AIRSPEED"      value="40." unit="m/s"/> <!-- nao tinha -->
    <define name="CARROT"                value="4."   unit="s"/>
    <define name="KILL_MODE_DISTANCE"    value="(1.5*MAX_DIST_FROM_HOME)"/>
    <define name="NO_XBEE_API_INIT"      value="TRUE"/>
    <define name="TRIGGER_DELAY"         value="1."/> <!-- usado em nav_bomb-->
    <define name="DEFAULT_CIRCLE_RADIUS" value="80."/>
    <define name="UNLOCKED_HOME_MODE"    value="TRUE"/>
    <define name="RC_LOST_MODE"          value="PPRZ_MODE_AUTO2"/>
    <define name="CAM_ROLL_START_MODE"   value="1"/>
    <define name="CAM_PHI_MAX"           value="RadOfDeg(25.)"/>    
  </section>

  <section name="VERTICAL CONTROL" prefix="V_CTL_">
    <!--define name="POWER_CTL_BAT_NOMINAL" value="11.1" unit="volt"/-->
    <!-- outer loop proportional gain -->
    <define name="ALTITUDE_PGAIN" value="0.09"/> <!-- site diz 0.1 - estava 0.040 -->
    <!-- outer loop saturation -->
    <define name="ALTITUDE_MAX_CLIMB" value="3.5"/> <!--3.5-->

    <!-- Cruise throttle + limits -->
    <define name="AUTO_THROTTLE_NOMINAL_CRUISE_THROTTLE" value="0.6"/>
    <define name="AUTO_THROTTLE_MIN_CRUISE_THROTTLE" value="0.4"/>
    <define name="AUTO_THROTTLE_MAX_CRUISE_THROTTLE" value="0.9"/>
    <define name="AUTO_PITCH_MAX_PITCH" value="RadOfDeg(20.)"/>
    <define name="AUTO_PITCH_MIN_PITCH" value="-RadOfDeg(25.)"/>

    <!-- Climb loop (throttle) -->
    <define name="AUTO_THROTTLE_CLIMB_THROTTLE_INCREMENT" value="0.1" unit="%/(m/s)"/> <!-- -0.2  0.1 site diz 0.25 -->
    <define name="AUTO_THROTTLE_PGAIN" value="0.004"/> <!-- -0.005 -->
    <define name="AUTO_THROTTLE_DGAIN" value="0.01"/> <!-- 0.005 -->
    <define name="AUTO_THROTTLE_IGAIN" value="0.004"/> <!-- 0.005 -->

    <!-- Climb loop (pitch) -->
    <define name="AUTO_THROTTLE_PITCH_OF_VZ_PGAIN" value="0.10"/> <!-- site diz 0.15 estava 0.02   maior valor mais pitch para ajustar altitude-->
    <define name="AUTO_PITCH_PGAIN" value="0.01"/> <!-- 0.018  0.028    -0.038 -->
    <define name="AUTO_PITCH_DGAIN" value="0.006"/> <!-- 0.050 0.030    -0.036 -->
    <define name="AUTO_PITCH_IGAIN" value="0.002"/>

    <!-- airspeed control -->
    <define name="AUTO_AIRSPEED_SETPOINT" value="24."/>   <!-- 28 voa muito bem -->
    <define name="AUTO_AIRSPEED_THROTTLE_PGAIN" value="0.003"/> <!--0.002   0.058-->
    <define name="AUTO_AIRSPEED_THROTTLE_DGAIN" value="0.006"/> <!--0.2-->
    <define name="AUTO_AIRSPEED_THROTTLE_IGAIN" value="0.003"/> <!--0.03-->
    <define name="AUTO_AIRSPEED_PITCH_PGAIN" value="0.007"/> <!-- 0.12 0.07   0.06 voa bem -->
    <define name="AUTO_AIRSPEED_PITCH_DGAIN" value="0.005"/> <!--0.01-->
    <define name="AUTO_AIRSPEED_PITCH_IGAIN" value="0.0"/> <!--0.022-->
    <define name="AIRSPEED_MAX" value="52"/>
    <define name="AIRSPEED_MIN" value="16"/>

    <!-- groundspeed control -->
    <define name="AUTO_GROUNDSPEED_SETPOINT" value="10"/>
    <define name="AUTO_GROUNDSPEED_PGAIN" value="0.0466"/> <!--1.0-->
    <define name="AUTO_GROUNDSPEED_IGAIN" value="0.372"/> <!--0.065-->

    <!-- pitch trim --> <!-- 5 deg -->
    <define name="PITCH_LOITER_TRIM" value="RadOfDeg(0.)"/>
    <define name="PITCH_DASH_TRIM" value="RadOfDeg(-0.)"/>

    <define name="THROTTLE_SLEW" value="0.5"/>
  </section>

  <section name="HORIZONTAL CONTROL" prefix="H_CTL_">
    <define name="COURSE_PGAIN" value="1.600"/> <!--2.0  1.880 nao faz scan encima das linhas -->	
    <define name="COURSE_DGAIN" value="0.300"/> <!--0.400 -->
    <define name="COURSE_PRE_BANK_CORRECTION" value=".5"/>  <!-- 0.7nao tinha -->
    <define name="ROLL_MAX_SETPOINT" value="40" unit="deg"/>   <!-- 45 -->
    <define name="PITCH_MAX_SETPOINT" value="25" unit="deg"/>
    <define name="PITCH_MIN_SETPOINT" value="-25" unit="deg"/>
    <define name="PITCH_PGAIN" value="11000."/> <!--8500-->
    <define name="PITCH_IGAIN" value="1250"/> <!-- ------- 9 setembro - coloquei 1250 antes estava zero - agora voa novelado sem trimm ------- -->
    <define name="PITCH_DGAIN" value="15.0"/>  <!-- 10.0 -->
    <define name="PITCH_OF_ROLL" value="RadOfDeg(5.0)"/> <!-- 10 nao tinha -->
    <define name="AILERON_OF_THROTTLE" value="0.0"/> <!-- nao tinha -->
    <define name="ELEVATOR_OF_ROLL" value="500"/>  <!-- quanto de elevador quando se da comando de aileron -->
    <define name="ROLL_ATTITUDE_GAIN" value="16000"/> <!-- 10000 -->
    <define name="ROLL_RATE_GAIN" value="3500"/> <!-- 600 -->
  </section>

  <section name="AHRS" prefix="AHRS_">
    <define name="AHRS_USE_GPS_HEADING"/>
    <!-- valores para porto alegre -->
    <define name="H_X" value=" 0.75127"/>
    <define name="H_Y" value=" 0.21477"/>
    <define name="H_Z" value=" 0.62406"/>
  </section>

  <section name="NAV">
    <define name="NAV_PITCH" value="0."/>
    <define name="NAV_GLIDE_PITCH_TRIM" value="0"/>
  </section>


  <section name="AGGRESSIVE" prefix="AGR_">
    <define name="BLEND_START" value="50"/><!-- Altitude Error to Initiate Aggressive Climb CANNOT BE ZERO!!-->
    <define name="BLEND_END" value="30"/><!-- Altitude Error to Blend Aggressive to Regular Climb Modes  CANNOT BE ZERO!!-->
    <define name="CLIMB_THROTTLE" value="0.85"/><!-- 0.75  Gaz for Aggressive Climb -->
    <define name="CLIMB_PITCH" value="RadOfDeg(15)"/>   <!-- 20 --> <!-- Pitch for Aggressive Climb -->
    <define name="DESCENT_THROTTLE" value="0.45"/><!-- Gaz for Aggressive Decent -->
    <define name="DESCENT_PITCH" value="RadOfDeg(-20)"/><!-- Pitch for Aggressive Decent -->
    <define name="CLIMB_NAV_RATIO" value="0.5"/><!-- 0.8  Percent Navigation for Altitude Error Equal to Start Altitude -->
    <define name="DESCENT_NAV_RATIO" value="1.0"/>
  </section>

<!--############################################################################################################-->
<!--############################################################################################################-->
<!--############################################################################################################-->

	<modules>
		<load name="openlog.xml"/>
 		
		<load name="airspeed_ms45xx_i2c.xml">
			<define name="MS45XX_SYNC_SEND"/>
    			<define name="MS45XX_I2C_DEV" value="i2c0"/>
			<define name="MS45XX_PRESSURE_RANGE" value="1"/>
			<define name="MS45XX_PRESSURE_OFFSET" value="8544.0"/>
		</load>
		<load name="airspeed_ets.xml"/>
		<load name="baro_ms5611_i2c.xml"/>

		<load name="temp_adc.xml">
    			<define name="TEMP_ADC_CHANNEL1" value="ADC_0"/>
			<define name="TEMP_ADC_CHANNEL1_TYPE_LM35"/>
    			<define name="TEMP_ADC_CHANNEL2" value="ADC_1"/>
			<define name="TEMP_ADC_CHANNEL2_TYPE_LM35"/>
		</load>

              <!--  <load name="photogrammetry_calculator.xml" /> -->
		<load name="digital_cam.xml">
      			<define name="DC_SHUTTER_GPIO" value="GPIOB,GPIO22"/><!-- 18:aux 22:camsw-->		
			<define name="DC_SHUTTER_DELAY"  value="2"/>	<!-- original = 2-->		
			<define name="DC_PUSH" value="gpio_set" />
			<define name="DC_RELEASE" value="gpio_clear" />
			<define name="DC_IMAGE_BUFFER" value="16535"/>
		</load>

		<!--<load name="cam_roll.xml"/>-->

    		<load name="nav_catapult.xml"/>
		<load name="nav_line.xml"/>
		<load name="nav_line_osam.xml"/>
		<load name="nav_survey_polygon.xml"/>
		<load name="nav_survey_poly_osam.xml"/>
	</modules>

  <section name="DIGITAL_CAMERA" prefix="DC_">
    <define name="AUTOSHOOT_QUARTERSEC_PERIOD" value="8" unit="quarter_second"/>
    <define name="AUTOSHOOT_METER_GRID" value="80" unit="meter"/>
    <define name="DOWNLINK_SEND_DC_INFO"/>
  </section>

  <section name="CATAPULT" prefix="NAV_CATAPULT_" >
    <define name="MOTOR_DELAY" value="45" />
    <!--<define name="HEADING_DELAY" value="(60*3)" />-->
    <define name="ACCELERATION_THRESHOLD" value="1.75" />
    <define name="INITIAL_PITCH" value="(15.0/57.0)" />
    <define name="INITIAL_THROTTLE" value="1.0" />
  </section>

 <section name="Photogrammetry" prefix="PHOTOGRAMMETRY_">
    <!-- Camera Parameters -->
    <define name="FOCAL_LENGTH" value="16" unit="mm"/>			<!-- valores NX1000 -->
    <define name="SENSOR_WIDTH" value="23.5" unit="mm"/>                <!-- In direction of the plane's wings -->
    <define name="SENSOR_HEIGHT" value="15.7" unit="mm"/>               <!-- In direction of the plane's nose -->
    <define name="PIXELS_WIDTH" value="5472" unit=""/>

    <!-- Photogrammetry Parameters : defined per flightplan -->
    <define name="OVERLAP" value="70" unit="PROCENT"/>
    <define name="SIDELAP" value="50" unit="PROCENT"/>
    <define name="RESOLUTION" value="100" unit="mm pixel projection"/>

    <!-- Flight Safety Parameters -->
    <define name="HEIGHT_MIN" value="100" unit="m"/>
    <define name="HEIGHT_MAX" value="400" unit="m"/>
    <define name="RADIUS_MIN" value="80" unit="m"/>
  </section>

  <section name="FAILSAFE" prefix="FAILSAFE_">
    <define name="DELAY_WITHOUT_GPS" value="3" unit="s"/>
    <define name="DEFAULT_THROTTLE" value="0.4" unit="%"/>
    <define name="DEFAULT_ROLL" value="15" unit="deg"/>
    <define name="DEFAULT_PITCH" value="0" unit="deg"/>
    <define name="HOME_RADIUS" value="80" unit="m"/>
  </section>

</airframe>
