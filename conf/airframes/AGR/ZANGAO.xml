<!DOCTYPE airframe SYSTEM "../airframe.dtd">

<!--
    Fuselagem ZANGAO Flywing
    UMARIN v1 board
    AiRSPEED MS45XX
    Telemetry 100mw transparent mode
-->

<airframe name="ZANGAO">
	<firmware name="fixedwing">
		<target name="ap" board="umarim_1.0"/>
		<target name="sim" board="pc"/>
    		<define name="AGR_CLIMB"/>
		<!--    <define name="LOITER_TRIM"/>  -->
		    <define name="WIND_INFO"/>
		    <define name="WIND_INFO_RET"/>
		<!--    <define name="STRONG_WIND"/>  -->
		<define name="USE_I2C0"/>
		<define name="USE_I2C1"/>
		<define name="USE_ADC"/>
		<define name="USE_ADC_3"/>  <!-- current_sensor-->
		<define name="USE_ADC_2"/>  <!-- esc_temp_sensor-->
                <define name="USE_AIRSPEED"/>
		<define name="USE_AIRSPEED_MS45XX"/>	
		<define name="SENSOR_SYNC_SEND"/>
		<subsystem name="radio_control" type="ppm"/>
<!--                <define name="RADIO_KILL_SWITCH" value="RADIO_CH6"/> -->
		<subsystem name="telemetry" type="transparent"/>
		<subsystem name="control" type="new"/>
		<subsystem name="ahrs" type="int_cmpl_quat">
			<configure name="USE_MAGNETOMETER" value="0"/>
			<define name="AHRS_USE_GPS_HEADING"/>
			<define name="AHRS_GRAVITY_UPDATE_COORDINATED_TURN"/>
			<define name="AHRS_GRAVITY_UPDATE_NORM_HEURISTIC"/>
		</subsystem>
		<subsystem name="imu" type="umarim"/>
		<define name="UMARIM_UPSIDE_DOWN"/>
		<subsystem name="gps" type="ublox"/>  <!--mediatek_diy-->
		    <configure name="GPS_BAUD" value="B38400"/>
                   <!-- <define name="GPS_TIMESTAMP"/> -->
		<subsystem name="navigation"/>
                <subsystem name="ins" type="alt_float"/>
		    <!-- <define name="USE_BAROMETER"/>
		    <define name="USE_BARO_MS5611"/>
                    <define name="INS_BARO_ID"  value="BARO_MS5611_SENDER_ID"/> -->
		<define name="COMMAND_PITCH_TRIM" value="0"/>
		<define name="COMMAND_ROLL_TRIM"  value="0"/>
	</firmware>

<!-- commands section -->
	<servos>
    		<servo name="THROTTLE"      no="1" min="1000" neutral="1000" max="2000"/>
		<servo name="AILEVON_LEFT"  no="0" min="1200" neutral="1500" max="1700"/>
		<servo name="AILEVON_RIGHT" no="2" min="1700" neutral="1500" max="1200"/>
		<servo name="PARACHUTE"     no="3" min="1450" neutral="1750" max="1850"/>
		<servo name="CAM_ROLL"      no="6" min="1600" neutral="1500" max="1400"/>
	</servos>

	<commands>
		<axis name="THROTTLE"  failsafe_value="0"/>
		<axis name="ROLL"      failsafe_value="0"/>
		<axis name="PITCH"     failsafe_value="0"/>
		<axis name="CAM_ROLL"  failsafe_value="0"/>
		<axis name="PARACHUTE" failsafe_value="0"/>
	</commands>

	<rc_commands>
		<set command="THROTTLE"  value="@THROTTLE"/>
		<set command="ROLL"      value="@ROLL"/>
		<set command="PITCH"     value="@PITCH"/>
		<set command="PARACHUTE" value="@CH8"/>	
	</rc_commands>
 
	<auto_rc_commands>

	</auto_rc_commands>
	
	<ap_only_commands>
<!--	  <copy command="CAM_ROLL"/> -->
	</ap_only_commands>

	<section name="MIXER">
		<define name="AILEVON_AILERON_RATE"  value="0.70"/>
		<define name="AILEVON_ELEVATOR_RATE" value="0.70"/>
                <define name="AILERON_DIFF" value="0.8"/>
	</section>
<!--
  <command_laws>
    <let var="roll" value="@ROLL"/>
    <set servo="AILERON_LEFT" value="($roll > 0 ? AILERON_DIFF : 1) * $roll"/>
    <set servo="AILERON_RIGHT" value="($roll > 0 ? 1 : AILERON_DIFF) * $roll"/>
-->

  <command_laws>
    <set servo="THROTTLE" value="@THROTTLE"/>
    <let var="roll" value="@ROLL * AILEVON_AILERON_RATE"/>
    <let var="pitch" value="@PITCH * AILEVON_ELEVATOR_RATE"/>

   <!-- <set servo="AILERON_LEFT" value="($roll > 0 ? AILERON_DIFF : 1) * $roll + $pitch"/>
    <set servo="AILERON_RIGHT" value="($roll > 0 ? 1 : AILERON_DIFF) * $roll + $pitch"/> -->
 
    <set servo="AILEVON_LEFT"  value="-$roll + $pitch"/>
    <set servo="AILEVON_RIGHT" value=" $roll + $pitch"/>
    <set servo="CAM_ROLL"  value="@CAM_ROLL"/>
    <set servo="PARACHUTE" value="@PARACHUTE"/>
  </command_laws>

  <section name="AUTO1" prefix="AUTO1_">
    <define name="MAX_ROLL" value="45" unit="deg"/>  <!-- 50 -->
    <define name="MAX_PITCH" value="45" unit="deg"/> <!-- 35-->
  </section>

  <section name="IMU" prefix="IMU_">
    <!-- Calibration Neutral -->
    <define name="GYRO_P_NEUTRAL" value="0"/>
    <define name="GYRO_Q_NEUTRAL" value="0"/>
    <define name="GYRO_R_NEUTRAL" value="0"/>

    <!-- SENS ITG3200  1/14.375 (deg/s)/LSB, rate frac 12bit => 1/14.375 * pi / 180 * 2^12 -->
    <define name="GYRO_P_SENS" value="4.97312" integer="16"/>
    <define name="GYRO_Q_SENS" value="4.97312" integer="16"/>
    <define name="GYRO_R_SENS" value="4.97312" integer="16"/>

    <define name="ACCEL_X_NEUTRAL" value="0"/>
    <define name="ACCEL_Y_NEUTRAL" value="0"/>
    <define name="ACCEL_Z_NEUTRAL" value="0"/>

    <!-- SENS ADXL345 16G 31.2 mg/LSB, accel frac 10bit => 31.2 * 2^10 / 1000 -->
    <define name="ACCEL_X_SENS" value="37.91"  integer="10"/>
    <define name="ACCEL_Y_SENS" value="37.91"  integer="10"/>
    <define name="ACCEL_Z_SENS" value="39.24"  integer="10"/>

    <!-- Just to compile -->
    <define name="MAG_X_NEUTRAL" value="0"/>
    <define name="MAG_Y_NEUTRAL" value="0"/>
    <define name="MAG_Z_NEUTRAL" value="0"/>

    <define name="BODY_TO_IMU_PHI" value="0"/> <!--roll -->
    <define name="BODY_TO_IMU_THETA" value="0"/> <!--pitch  -->
    <define name="BODY_TO_IMU_PSI" value="0"/>
  </section>


<!-- ======================================================================== -->
  <section name="INS" prefix="INS_">
    <define name="ROLL_NEUTRAL_DEFAULT"  value="0" unit="deg"/>
    <define name="PITCH_NEUTRAL_DEFAULT" value="0" unit="deg"/>
  </section>
<!-- ======================================================================== -->

  <section name="BAT">
    <define name="ADC_CHANNEL_CURRENT"   value="ADC_3"/>
    <define name="MilliAmpereOfAdc(adc)"  value="(238*(adc-539))"/>    <!-- offset 501 sensor 100amp 20mv/amp 2.5v offset  -->
    <!-- <define name="MilliAmpereOfAdc(adc)" value="(128*(adc-122))"/> -->  <!-- sensor 100amp  -->
    <define name="CATASTROPHIC_BAT_LEVEL" value="9.3" unit="V"/>
    <define name="CRITIC_BAT_LEVEL"       value="9.8" unit="V"/>
    <define name="LOW_BAT_LEVEL"          value="10.0" unit="V"/>
    <define name="MAX_BAT_LEVEL"          value="12.4" unit="V"/>
  </section>

  <section name="MISC">
    <define name="SENSOR_SYNC_SEND"/>
    <define name="MINIMUM_AIRSPEED"      value="16." unit="m/s"/> <!-- nao tinha -->
    <define name="NOMINAL_AIRSPEED"      value="20." unit="m/s"/> <!--28.muito bom - nao cai nas curvas a 50ยบ --> 
    <define name="MAXIMUM_AIRSPEED"      value="36." unit="m/s"/> <!-- nao tinha -->
    <define name="CARROT"                value="4."   unit="s"/>
    <define name="KILL_MODE_DISTANCE"    value="(1.5*MAX_DIST_FROM_HOME)"/>
    <define name="NO_XBEE_API_INIT"      value="TRUE"/>
    <define name="TRIGGER_DELAY"         value="1."/> <!-- usado em nav_bomb-->
    <define name="DEFAULT_CIRCLE_RADIUS" value="60."/>
    <define name="UNLOCKED_HOME_MODE"    value="TRUE"/>
    <define name="RC_LOST_MODE"          value="PPRZ_MODE_AUTO2"/>
    <define name="CAM_ROLL_START_MODE"   value="1"/>
    <define name="CAM_PHI_MAX"           value="RadOfDeg(25.)"/>    
  </section>

  <section name="VERTICAL CONTROL" prefix="V_CTL_">
    <!--define name="POWER_CTL_BAT_NOMINAL" value="11.1" unit="volt"/-->
    <!-- outer loop proportional gain -->
    <define name="ALTITUDE_PGAIN" value="0.05"/> <!-- 0.09 - estava 0.040 - site diz 0.1 - -->
    <!-- outer loop saturation -->
    <define name="ALTITUDE_MAX_CLIMB" value="3.5"/> <!--3.5-->

    <!-- Cruise throttle + limits -->
    <define name="AUTO_THROTTLE_NOMINAL_CRUISE_THROTTLE" value="0.55"/>
    <define name="AUTO_THROTTLE_MIN_CRUISE_THROTTLE" value="0.4"/>
    <define name="AUTO_THROTTLE_MAX_CRUISE_THROTTLE" value="0.9"/>
    <define name="AUTO_PITCH_MAX_PITCH" value="RadOfDeg(25.)"/>
    <define name="AUTO_PITCH_MIN_PITCH" value="-RadOfDeg(25.)"/>

    <!-- Climb loop (throttle) -->
    <define name="AUTO_THROTTLE_CLIMB_THROTTLE_INCREMENT" value="0.008" unit="%/(m/s)"/> <!--0.2 site diz 0.25 - 0.1-->
    <define name="AUTO_THROTTLE_PGAIN" value="0.014"/> <!-- -0.021  0.004 -->
    <define name="AUTO_THROTTLE_DGAIN" value="0.005"/>  <!-- 0.01   -->
    <define name="AUTO_THROTTLE_IGAIN" value="0.0"/>   <!-- 0.004  -->

    <!-- Climb loop (pitch) -->
    <define name="AUTO_THROTTLE_PITCH_OF_VZ_PGAIN" value="0.03"/> <!-- 0.11  site diz 0.15 estava 0.02   maior valor mais pitch para ajustar altitude-->
    <define name="AUTO_PITCH_PGAIN" value="0.015"/> <!-- 0.01  -->
    <define name="AUTO_PITCH_DGAIN" value="0.000"/> <!-- 0.006 -->
    <define name="AUTO_PITCH_IGAIN" value="0.003"/> <!-- 0.002 -->

    <!-- airspeed control -->
    <define name="AUTO_AIRSPEED_SETPOINT" value="20.0"/>   <!-- 28 voa muito bem -->
    <define name="AUTO_AIRSPEED_THROTTLE_PGAIN" value="0.1"/>
    <define name="AUTO_AIRSPEED_THROTTLE_DGAIN" value="0.12"/>
    <define name="AUTO_AIRSPEED_THROTTLE_IGAIN" value="0.0"/>
    <define name="AUTO_AIRSPEED_PITCH_PGAIN" value="0.06"/>
    <define name="AUTO_AIRSPEED_PITCH_DGAIN" value="0.0"/>
    <define name="AUTO_AIRSPEED_PITCH_IGAIN" value="0.042"/>
    <define name="AIRSPEED_MAX" value="40"/> <!-- bound setpoint -->
    <define name="AIRSPEED_MIN" value="16"/>

    <!-- groundspeed control -->
    <define name="AUTO_GROUNDSPEED_SETPOINT" value="10.0" unit="m/s"/>
    <define name="AUTO_GROUNDSPEED_PGAIN" value="1.0"/> <!--1.0-->
    <define name="AUTO_GROUNDSPEED_IGAIN" value="0.0"/> <!--0.065-->



    <!-- pitch trim --> <!-- 5 deg -->
    <define name="PITCH_LOITER_TRIM" value="RadOfDeg(0.)"/>
    <define name="PITCH_DASH_TRIM" value="RadOfDeg(-0.)"/>

    <!--<define name="THROTTLE_SLEW" value="0.1"/>-->
  </section>

  <section name="HORIZONTAL CONTROL" prefix="H_CTL_">
    <define name="COURSE_PGAIN" value="1.500"/> <!--2.0  1.880 -->	
    <define name="COURSE_DGAIN" value="0.3"/> <!--0.400 -->
    <define name="COURSE_PRE_BANK_CORRECTION" value=".8"/>
    <define name="ROLL_MAX_SETPOINT" value="45" unit="deg"/>   <!-- 45 -->
    <define name="PITCH_MAX_SETPOINT" value="25" unit="deg"/>
    <define name="PITCH_MIN_SETPOINT" value="-25" unit="deg"/>
    <define name="PITCH_PGAIN" value="7500."/> <!-- 5500 11000 8500-->
    <define name="PITCH_IGAIN" value="50"/>
    <define name="PITCH_DGAIN" value="25.0"/>  <!-- 10.0 -->
    <define name="PITCH_OF_ROLL" value="RadOfDeg(5.0)"/> <!-- 10 nao tinha -->
    <define name="AILERON_OF_THROTTLE" value="0.0"/> <!-- nao tinha -->
    <define name="ELEVATOR_OF_ROLL" value="500"/>  <!-- quanto de elevador quando se da comando de aileron -->
    <define name="ROLL_ATTITUDE_GAIN" value="8000"/> <!-- 16000 - 10000 -->
    <define name="ROLL_RATE_GAIN" value="1200"/> <!-- 3500 - 600 -->
    <!-- maybe handy to avoid over corner with lots of wind and small airframe -->
    <!-- <define name="COURSE_SLEW_INCREMENT" value="RadOfDeg(4)"/> -->
  </section>

  <section name="AHRS" prefix="AHRS_">
    <define name="AHRS_USE_GPS_HEADING"/>
    <!-- valores para porto alegre -->
    <define name="H_X" value=" 0.75127"/>
    <define name="H_Y" value=" 0.21477"/>
    <define name="H_Z" value=" 0.62406"/>
  </section>

  <section name="NAV">
    <define name="NAV_PITCH" value="0."/>
    <define name="NAV_GLIDE_PITCH_TRIM" value="0"/>
  </section>


  <section name="AGGRESSIVE" prefix="AGR_">
    <define name="BLEND_START" value="50"/><!-- Altitude Error to Initiate Aggressive Climb CANNOT BE ZERO!!-->
    <define name="BLEND_END" value="30"/><!-- Altitude Error to Blend Aggressive to Regular Climb Modes  CANNOT BE ZERO!!-->
    <define name="CLIMB_THROTTLE" value="0.90"/><!-- 0.75  Gaz for Aggressive Climb -->
    <define name="CLIMB_PITCH" value="RadOfDeg(15)"/>   <!-- 20 --> <!-- Pitch for Aggressive Climb -->
    <define name="DESCENT_THROTTLE" value="0.35"/><!-- Gaz for Aggressive Decent -->
    <define name="DESCENT_PITCH" value="RadOfDeg(-20)"/><!-- Pitch for Aggressive Decent -->
    <define name="CLIMB_NAV_RATIO" value="0.3"/><!-- 0.8  Percent Navigation for Altitude Error Equal to Start Altitude -->
    <define name="DESCENT_NAV_RATIO" value="1.0"/>
  </section>

<!--############################################################################################################-->
<!--############################################################################################################-->
<!--############################################################################################################-->

	<modules>
		<load name="consume_fixedwing.xml"/>
		<load name="openlog.xml"/>
    <load name="sys_mon.xml"/>
		<!--<load name="baro_ms5611_i2c.xml"/> -->
		<load name="airspeed_ms45xx_i2c.xml">
    			<define name="MS45XX_I2C_DEV" value="i2c0"/>
			<define name="MS45XX_PRESSURE_RANGE" value="1"/>
			<define name="MS45XX_OUTPUT_TYPE" value="0"/>
			<define name="MS45XX_PRESSURE_OFFSET" value="8501.0"/> <!-- 8542.0 sensor HK-->
		</load>

		<!--<load name="adc_generic.xml">
    			<configure name="ADC_CHANNEL_GENERIC1" value="ADC_2"/>
		</load> -->

		<load name="temp_adc.xml">
    			<define name="TEMP_ADC_CHANNEL1" value="ADC_2"/>
			<define name="TEMP_ADC_CHANNEL1_TYPE" value="LM35"/>
		</load>

              <!--  <load name="photogrammetry_calculator.xml" /> -->

		<load name="nav_parachute.xml">
			<define name="RC_PARACHUTE_RELEASE" value="RADIO_CH8"/>
		</load>

		<load name="digital_cam_shoot_rc.xml">
 			<define name="DC_RADIO_SHOOT" value="RADIO_CH7"/>
		</load>

		<load name="digital_cam.xml">
      		<define name="DC_SHUTTER_GPIO" value="GPIOA,GPIO15"/>		
			<define name="DC_SHUTTER_DELAY"  value="1"/>	
			<define name="DC_PUSH" value="gpio_set" />
			<define name="DC_RELEASE" value="gpio_clear" />
			<define name="DC_IMAGE_BUFFER" value="16535"/>
		</load>

		<!--<load name="cam_roll.xml"/> -->

		<load name="nav_catapult.xml"/>    		
		<load name="nav_line.xml"/>
		<load name="nav_line_osam.xml"/>
		<load name="nav_survey_polygon.xml"/>
		<load name="nav_survey_poly_osam.xml">
			<define name="POLY_OSAM_DEFAULT_SIZE" value="10"/>
			<define name="POLY_OSAM_DEFAULT_SWEEP" value="100"/>
			<define name="POLY_OSAM_ENTRY_RADIUS" value="0"/>
			<define name="POLY_OSAM_MIN_RADIUS" value="50"/>
			<define name="POLY_OSAM_FIRST_SWEEP_DISTANCE" value="10"/>
		</load>
	</modules>

<!--############################################################################################################-->
<!--############################################################################################################-->
<!--############################################################################################################-->

  <section name="DIGITAL_CAMERA" prefix="DC_">
    <define name="AUTOSHOOT_QUARTERSEC_PERIOD" value="8" unit="quarter_second"/>
    <define name="AUTOSHOOT_METER_GRID" value="80" unit="meter"/>
    <define name="DOWNLINK_SEND_DC_INFO"/>
  </section>

  <section name="CATAPULT" prefix="NAV_CATAPULT_" >
    <define name="MOTOR_DELAY" value="45" />
    <!--<define name="HEADING_DELAY" value="(60*3)" />-->
    <define name="ACCELERATION_THRESHOLD" value="1.75" />
    <define name="INITIAL_PITCH" value="(15.0/57.0)" />
    <define name="INITIAL_THROTTLE" value="1.0" />
  </section>

 <section name="Photogrammetry" prefix="PHOTOGRAMMETRY_">
    <!-- Camera Parameters -->
    <define name="FOCAL_LENGTH" value="16" unit="mm"/>			<!-- valores NX1000 -->
    <define name="SENSOR_WIDTH" value="23.5" unit="mm"/>                <!-- In direction of the plane's wings -->
    <define name="SENSOR_HEIGHT" value="15.7" unit="mm"/>               <!-- In direction of the plane's nose -->
    <define name="PIXELS_WIDTH" value="5472" unit=""/>

    <!-- Photogrammetry Parameters : defined per flightplan -->
    <define name="OVERLAP" value="70" unit="PROCENT"/>
    <define name="SIDELAP" value="50" unit="PROCENT"/>
    <define name="RESOLUTION" value="100" unit="mm pixel projection"/>

    <!-- Flight Safety Parameters -->
    <define name="HEIGHT_MIN" value="100" unit="m"/>
    <define name="HEIGHT_MAX" value="400" unit="m"/>
    <define name="RADIUS_MIN" value="80" unit="m"/>
  </section>

  <section name="FAILSAFE" prefix="FAILSAFE_">
    <define name="DELAY_WITHOUT_GPS" value="3" unit="s"/>
    <define name="DEFAULT_THROTTLE" value="0.4" unit="%"/>
    <define name="DEFAULT_ROLL" value="15" unit="deg"/>
    <define name="DEFAULT_PITCH" value="0" unit="deg"/>
    <define name="HOME_RADIUS" value="80" unit="m"/>
  </section>

  <section name="GCS">
    <define name="AC_ICON" value="flyingwing"/>
  </section>

</airframe>
